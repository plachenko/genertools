<script lang="ts">
  import { onMount } from "svelte";

  import ProjectDrawer from "$lib/components/OpenAI/Project/Drawer.svelte";
  import ProjectView from "$lib/components/ProjectView.svelte";
  import { slide } from "svelte/transition";

  let measureCont = $state(null);
  let apps = $state([]);
  let sortType = $state(1);
  let sortReversed = $state(0);
  let sortOptions = $state(["Alphabetical", "Date Created", "Times Opened"]);

  let projSelected = $state(null);
  let projects = $state(Array(24));

  let sepWidth = $state(0);
  let sepHeight = $state(0);

  let curApp = $state(null);
  let curPage = $state(0);

  let showFilter = $state(false);

  let appContainer = $state(null);
  let swipeType = $state(0);

  let bSize = $state(60);
  let bCont = $state(null);

  let gapSize = $state(15);
  let scrollLocked = $state(true);
  let projNum = $state(80);
  let pageNum = $state(0);
  let maxProjNumX = $state(6);
  let maxProjNumY = $state(3);

  let gridColsStrng = $state("grid-cols-2");

  $effect(() => {
    let projTot = maxProjNumX * maxProjNumY;
    pageNum = ~~(projects.length / projTot);
    console.log(projects.length, pageNum, projTot);
    if (bCont) {
      maxProjNumX = Math.round(bCont.clientWidth / bSize);
    }
    gridColsStrng = "grid-cols-" + maxProjNumX;
    console.log(maxProjNumX, gridColsStrng);
  });

  function setCurPage(pageOffset) {
    if (
      ((curPage <= 0 && pageOffset < 0) ||
        (curPage >= pageNum - 1 && pageOffset > 0)) &&
      scrollLocked
    ) {
      return;
    }
    curPage = curPage + pageOffset;
    curPage = Math.abs(curPage % pageNum);

    scrollPage();
  }

  function angleBetweenPoints(x1, y1, x2, y2, unit = "deg") {
    const dx = x2 - x1;
    const dy = y2 - y1;
    let angle = Math.atan2(dy, dx); // radians between -π and π

    if (unit === "deg") {
      angle = angle * (180 / Math.PI);
    }

    return angle;
  }

  function orientation(x1, y1, x2, y2) {
    const dx = Math.abs(x2 - x1);
    const dy = Math.abs(y2 - y1);

    if (dx === dy) return "diagonal";
    return dx < dy ? 0 : 1;
  }

  function scrollPage() {
    // let gridH = appContainer.parentNode.offsetHeight * curPage;
    let gridW = appContainer.parentNode.offsetWidth;

    let gridH = maxProjNumY * bSize;
    gridH = gridH * curPage;
    // gridH = gridH + curPage * 2;
    gridH = gridH + curPage;
    //let gridW = maxProjNumX * bSize + (8 + maxProjNumX) * maxProjNumX;

    appContainer.scrollTo({ top: gridH, behavior: "smooth" });
  }

  function setPaging() {
    let height = appContainer.clientHeight;
    let width = appContainer?.clientWidth;

    // console.log(~~(height / 60) / 10, width);
  }

  $effect(() => {
    console.log(appContainer?.parentNode.offsetHeight);
  });

  onMount(() => {
    // let gridH = appContainer.parentNode.offsetHeight - 100;
    //let gridW = appContainer.parentNode.offsetWidth - 100;

    let py = null;
    let px = null;

    sepWidth = window.innerWidth / 10;
    sepHeight = window.innerWidth / 10;

    // setGridSize();

    appContainer.addEventListener("pointerdown", (e) => {
      e.preventDefault();
      if (projSelected) return;

      py = e.clientY;
      px = e.clientX;
    });

    /*
    appContainer.addEventListener("pointermove", (e) => {
      appContainer.scrollTo({ top: py - e.clientY });
    });
    */

    appContainer.addEventListener("pointerup", (e) => {
      e.preventDefault();
      if (projSelected) return;

      if (orientation(e.clientX, e.clientY, px, py) !== swipeType) return;

      if (e.clientY < py) {
        setCurPage(1);
        console.log("swipe up");
      } else {
        setCurPage(-1);
        console.log("swipe down");
      }

      py = null;
    });

    window.addEventListener("resize", (e) => {
      // setGridSize();
      console.log(e.offset);
    });

    let ticking = false;

    setPaging();
  });

  function setGridSize() {
    // maxProjNumX = ~~(appContainer.parentNode.clientWidth / bSize);
    maxProjNumX = ~~(appContainer.parentNode.offsetWidth / bSize);
    maxProjNumY = ~~(appContainer.parentNode.offsetHeight / bSize);

    let gridH = maxProjNumY * bSize;
    let gridW = maxProjNumX * bSize;

    appContainer.style.width = `${gridW}px`;
    appContainer.style.height = `${gridH}px`;
  }

  function setCurApp(_idx) {
    curApp = _idx;
  }
</script>

<!-- Project Drawer -->

{#if curApp == null}
  <div class="w-full h-full">
    <div class="flex flex-col bg-red-400 h-full">
      <div class="shrink p-2 flex items-center">
        <div class="flex-1 flex flex-col">
          <div class="gap-2 flex flex-1 h-[130px]">
            <div class="bg-white flex-1 w-full p-2 rounded-md">
              <div class="relative overflow-scroll-x h-full">
                <div
                  contenteditable
                  class="absolute top-0 whitespace-nowrap left-0 h-full w-full bg-blue-400"
                ></div>
              </div>
            </div>
            <div>
              <button
                onclick={() => {
                  showFilter = !showFilter;
                }}>filter</button
              >
            </div>
          </div>
          {#if showFilter}
            <div transition:slide class="rounded-md flex-1">
              <div class="flex items-center mb-2 flex-1 flex-row gap-2">
                <label class="block text-sm font-medium flex-1">Sort</label>
                <select
                  bind:value={sortType}
                  class="bg-white w-full p-2 border rounded"
                >
                  {#each sortOptions as opt, idx}
                    <option value={idx} selected={idx == sortType}>{opt}</option
                    >
                  {/each}
                </select>
                <div class="flex flex-1 items-center gap-2">
                  <input
                    id="reversed"
                    type="checkbox"
                    bind:checked={sortReversed}
                  />
                  <label for="reversed" class="text-sm">Reverse</label>
                </div>
              </div>
            </div>
          {/if}
        </div>
      </div>

      <div bind:this={appContainer}></div>

      <div
        id="measure"
        bind:this={measureCont}
        class="bg-yellow-300 h-full w-full relative flex items-center justify-center"
      >
        <div class="border-t-2 w-full absolute">
          <div
            class="flex flex-col justify-center relative align-center h-10 bg-blue-300"
          >
            {#each Array(sepWidth) as sep, idx}
              <div
                style={`left: ${idx * 17}px; width: ${10}`}
                class={`absolute bg-red-300  h-2 border-l-2 top-0 opacity-30`}
              ></div>
            {/each}
            <div class="border-l-2 size-10"></div>
            <span class="">{measureCont?.clientWidth}px</span>
          </div>
        </div>
        <div class="border-r-2 h-full absolute">
          <div
            class="flex bg-green-300 flex-row justify-center relative align-center w-15 h-full opacity-30"
          >
            <span class="">{measureCont?.clientHeight}px</span>
            <div class="border-t-2 size-10"></div>
          </div>
        </div>
      </div>
      <div class="bg-green-400 flex-1 flex relative overflow-hidden">
        <div class="relative flex-1">
          <div class="flex flex-1 h-full w-full">
            {#each Array(maxProjNumX) as col}
              <div class="bg-red-300 flex-1 flex flex-col">
                {#each Array(maxProjNumX) as row}<div
                    class="flex-1 flex justify-center items-center"
                  >
                    <button
                      class="select-none cursor-pointer bg-white size-[60px] rounded-md"
                      >f</button
                    >
                  </div>
                {/each}
              </div>
            {/each}
          </div>
          <!--
          <div
            bind:this={bCont}
            class={`grid ${gridColsStrng} w-full h-full left-0 top-0 absolute`}
          >
            {#each Array(Math.pow(maxProjNumX, 2)) as b}
              <div
                class={`flex flex-1 justify-center items-center bg-red-400 p-2 size-[${bSize}px]`}
              >
                <div class="rounded-md bg-white h-full w-full"></div>
              </div>
            {/each}
          </div>
          -->
        </div>
      </div>

      <!--
      <div class="flex flex-1 bg-green-300 p-2">
        <div class="relative flex-1 flex justify-center">
          <div
            class="items-center rounded-md relative flex justify-center flex-1 bg-red-400"
          >
            <div
              bind:this={appContainer}
              class={`overflow-hidden bg-green-300 absolute grid grid-cols-[repeat(auto-fill,minmax(${bSize}px,1fr))] gap-[${gapSize}px] rounded-md h-[130px]`}
            >
              {#each projects as app, idx}
                <button
                  transition:slide
                  onclick={(e) => {
                    e.preventDefault();
                    if (projSelected == idx) {
                      projSelected = null;
                      return;
                    }
                    // projSelected = idx;
                  }}
                  class={`${projSelected == idx ? "border-4 border-neutral-400" : ""} cursor-pointer bg-slate-100 size-[${bSize}px] rounded-md`}
                  >{idx}</button
                >
              {/each}
            </div>
          </div>

          {#if !projSelected && pageNum}
            <div
              class="w-full h-full top-0 pointer-events-none left-[0px] absolute flex-1 flex justify-center items-center"
            >
              <div
                class={`${swipeType ? "" : "left-[0px] rotate-[90deg]"} pointer-events-auto bg-blue-400 flex p-1 rounded-md justify-center gap-2 absolute `}
              >
                <button
                  onclick={() => {
                    setCurPage(-1);
                  }}
                  class="cursor-pointer h-[20px] w-[30px] rounded-full bottom-[-1px] absolute left-[-40px] bg-blue-400 flex justify-center items-center text-white"
                  >-</button
                >
                {#each Array(pageNum) as dot, idx}
                  <button
                    onclick={() => {
                      curPage = idx;
                      scrollPage();
                    }}
                    class={`cursor-pointer ${idx == curPage ? "border-2 border-white" : ""} bg-red-400 rounded-full size-[10px]`}
                  ></button>
                {/each}
                <button
                  onclick={() => {
                    setCurPage(1);
                  }}
                  class="cursor-pointer h-[20px] w-[30px] rounded-full bottom-[-1px] absolute right-[-40px] bg-blue-400 flex justify-center items-center text-white"
                  >+</button
                >
              </div>
            </div>
          {/if}
        </div>
      </div>
-->

      <div class="flex bg-blue-400 p-2">
        <div class="bg-red-400 rounded-md flex items-center h-[80px] w-full">
          <div class=" p-2 border-r-2 shrink border-dashed">
            <button class={`bg-slate-300 rounded-md size-[60px]`}>+</button>
          </div>
          <div class="flex flex-1 gap-2 justify-between p-2">
            {#each projects.filter((e) => {
              return e.pinned;
            }) as pin, idx}
              <button
                class={`select-none w-full bg-slate-300 rounded-md size-[60px]`}
                >{idx}</button
              >
            {/each}
          </div>
        </div>
      </div>
      {#if projSelected !== null}
        <div
          transition:slide={{ y: 100 }}
          class="bg-yellow-300 w-full flex gap-1"
        >
          <div class="flex flex-col flex-1">
            <div
              class="flex-1 bg-red-400 font-bold p-2 justify-center bg-blue-300"
            >
              Project {projSelected}
            </div>

            <div class="flex-1 flex gap-1 p-2">
              {#each Array("Open", "Edit", "Delete") as opt}
                <button class="cursor-pointer flex-1 bg-slate-300 rounded-md"
                  >{opt}</button
                >
              {/each}
            </div>
          </div>
        </div>
      {/if}
    </div>
    <!-- <ProjectDrawer {setCurApp} /> -->
  </div>
{:else}
  <ProjectView />
{/if}
